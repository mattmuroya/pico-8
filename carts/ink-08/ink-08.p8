pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
function log(input)
	printh("> "..tostr(input))
end

function _init()
	p1={
		col=11, -- color
		pos={x=64,y=64}, -- position
		vel={x=0,y=0}, -- velocity
		dir=0.875, -- facing direction (angle)
		rad=4, -- radius
		acc=0.8, -- acceleration
		spd=0, -- current speed
		max=3, -- max speed
		dmp=0.8, -- dampening
		frt=10, -- fire rate (shots/second)
		cdn=0 -- weapon cooldown (frames)
	}
	cam={
		pos={x=0,y=0}
	}
	ptcs={}
end

function _update()
	move_player()
	shoot(p1)
	move_ptcs()
end

function _draw()
	cls()
	map()
	set_cam(p1.pos.x-64,p1.pos.y-64)
	draw_player(p1)
	draw_ptcs()
end

function move_player()
	local input=false
	if btn(0) then input=true p1.vel.x-=p1.acc end
	if btn(1) then input=true p1.vel.x+=p1.acc end
	if btn(2) then input=true p1.vel.y-=p1.acc end
	if btn(3) then input=true p1.vel.y+=p1.acc end
	if input then p1.dir=atan2(p1.vel.x,p1.vel.y) end
	p1.vel.x*=p1.dmp
	p1.vel.y*=p1.dmp
	if abs(p1.vel.x)<0.1 then p1.vel.x=0 end
	if abs(p1.vel.y)<0.1 then p1.vel.y=0 end
	p1.spd=sqrt(p1.vel.x^2+p1.vel.y^2)
	if p1.spd>p1.max then
		p1.vel.x*=p1.max/p1.spd
		p1.vel.y*=p1.max/p1.spd
		p1.spd=p1.max
	end
	p1.pos.x+=p1.vel.x
	if collide_map(p1) then
		p1.pos.x-=p1.vel.x
		-- p1.vel.x=0
	end
	p1.pos.y+=p1.vel.y
	if collide_map(p1) then
		p1.pos.y-=p1.vel.y
		-- p1.vel.y=0
	end
end

function collide_map(pl)
	-- TODO: fix collsion detection for deceleration
	local x1,y1=(pl.pos.x+pl.rad)/8,(pl.pos.y+pl.rad)/8
	local x2,y2=(pl.pos.x-pl.rad)/8,(pl.pos.y-pl.rad)/8
	return fget(mget(x1,y1),0)
		or fget(mget(x1,y2),0)
		or fget(mget(x2,y2),0)
		or fget(mget(x2,y1),0)
end

function shoot(pl)
	if btn(5) and pl.cdn<=0 then
		add(ptcs,{
			type="blob",
			act=pl, -- actor
			col=pl.col,
			pos={x=pl.pos.x,y=pl.pos.y},
			dir=pl.dir+(rnd()-0.5)*0.0625,
			rad=2,
			dur=13, -- duration
		})
		for i=1,3 do
			add(ptcs,{
				type="muzzle",
				act=pl,
				col=pl.col,
				pos={x=pl.pos.x,y=pl.pos.y},
				dir=pl.dir+(rnd()-0.5)*0.35,
				dur=4
			})
		end	
		pl.cdn=(30/pl.frt)
	elseif pl.cdn>0 then pl.cdn-=1 end
end

function move_ptcs()
	local mult
	for b in all(ptcs) do
		if b.dur<=0 then del(ptcs,b)
		else
			if b.type=="blob" then
				b.pos.x+=cos(b.dir)*(3+b.act.spd)
				b.pos.y+=sin(b.dir)*(3+b.act.spd) end
			if b.type=="muzzle" then
				b.pos.x+=cos(b.dir)*(1+b.dur)
				b.pos.y+=sin(b.dir)*(1+b.dur) end
			b.dur-=1
		end
	end
end

function draw_player(pl)
	circfill(pl.pos.x,pl.pos.y,pl.rad,pl.col)
end

function draw_ptcs()
	for p in all(ptcs) do
		if p.type=="blob" then
			circfill(p.pos.x,p.pos.y,p.rad,p.col) end
		if p.type=="muzzle" then
			circfill(p.pos.x,p.pos.y,p.dur,p.col) end
	end
end

function set_cam(x,y)
	if x<=0 then x=0 end
	if x>=128 then x=128 end
	if y<=0 then y=0 end
	if y>=128 then y=128 end
	camera(x,y)
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777776666666655555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777776666666655555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777776666666655555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777776666666655555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777776666666655555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777776666666655555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777776666666655555555
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777776666666655555555
__gff__
0000000000000000000000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0f0f0f0f0f0f0f0f0f0f0f0e0e0e0e0e0e0e0e0f0f0f0f0f0f0f0f0f0f0f0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0e0e0e0e0e0e0e0e0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0e0e0e0e0e0e0e0e0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0e0e0e0e0e0e0e0e0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0f0f0f0f0f0f0f0f0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e0e0d0d0d0d0d0d0d0d0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0d0d0d0d0d0d0d0d0f0f0f0f0f0f0d0d0d0d0d0d0d0d0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0f0f0f0f0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0f0f0f0f0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0e0e0e0e0e0e0e0e0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0e0e0e0e0e0e0e0e0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0e0e0e0e0e0e0e0e0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0d0d0d0d0d0d0d0d0d0d0d0e0e0e0e0e0e0e0e0d0d0d0d0d0d0d0d0d0d0d0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
